{% extends "base.html" %}

{% block title %}Behavior Tracker History - Vitruvian Tracker{% endblock %}

{% block extra_css %}
<style>
/* Behavior History Table */
.behavior-history-table {
    overflow-x: auto;
    margin-top: 1.5rem;
}

.behavior-history-table table {
    width: 100%;
    min-width: 800px;
    border-collapse: separate;
    border-spacing: 1.5rem 0.5rem;
}

.behavior-history-table th,
.behavior-history-table td {
    padding: 1.5rem 2.5rem;
    text-align: center;
    border: 1px solid #e9ecef;
    min-width: 100px;
    background-color: white;
}

.behavior-history-table th {
    background-color: #f8f9fa;
    font-weight: 600;
    position: sticky;
    top: 0;
    z-index: 10;
}

.behavior-history-table th.date-column {
    text-align: left;
    min-width: 120px;
}

.behavior-history-table td.date-cell {
    text-align: left;
    font-weight: 500;
    background-color: #f8f9fa;
}

.behavior-history-table tbody tr:hover {
    background-color: #f8f9fa;
}

.behavior-icon {
    font-size: 1.5rem;
    opacity: 0.3;
    transition: opacity 0.2s ease;
}

.behavior-icon.completed {
    opacity: 1;
}

.behavior-icon.bi-check-circle-fill {
    color: #28a745;
}

/* Date Range Selector */
.date-range-selector {
    display: flex;
    gap: 1rem;
    align-items: center;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
}

.date-range-selector .form-group {
    margin-bottom: 0;
}

.date-range-selector label {
    margin-bottom: 0.25rem;
    font-size: 0.875rem;
    font-weight: 500;
}

.date-range-selector input {
    max-width: 150px;
}

.stats-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: linear-gradient(135deg, var(--primary-color, #2563eb) 0%, var(--secondary-color, #3b82f6) 100%);
    color: white;
    padding: 1.5rem;
    border-radius: 0.5rem;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.stat-card h6 {
    margin-bottom: 0.5rem;
    font-size: 0.875rem;
    opacity: 0.9;
}

.stat-card .stat-value {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 0;
}

.behavior-legend {
    display: flex;
    flex-wrap: wrap;
    gap: 1.5rem;
    margin-bottom: 1.5rem;
    padding: 1rem;
    background-color: #f8f9fa;
    border-radius: 0.5rem;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.legend-color {
    width: 20px;
    height: 20px;
    border-radius: 0.25rem;
}

.export-button {
    margin-left: auto;
}

@media (max-width: 768px) {
    .behavior-history-table th,
    .behavior-history-table td {
        padding: 0.5rem;
        font-size: 0.875rem;
    }

    .behavior-icon {
        font-size: 1.25rem;
    }
}
</style>
{% endblock %}

{% block content %}
<!-- Dashboard Navbar -->
{% include 'components/navbar_auth.html' %}

<!-- Flash Messages -->
<div class="container mt-3">
    {% include 'components/flash_messages.html' %}
</div>

<!-- Behavior History Content -->
<div class="dashboard-container">
    <section class="page-header">
        <h1><i class="bi bi-calendar-check"></i> Behavior Tracker History</h1>
        <p class="text-muted">Historical behavior completion records</p>
        <div class="mt-3 d-flex gap-2">
            <a href="/dashboard" class="btn btn-outline-primary">
                <i class="bi bi-arrow-left"></i> Back to Dashboard
            </a>
            <a href="/behavior/manage" class="btn btn-primary">
                <i class="bi bi-gear"></i> Manage Behaviors
            </a>
        </div>
    </section>

    <!-- Stats Summary -->
    <div class="stats-summary" id="stats-summary">
        <div class="stat-card">
            <h6>Total Days Tracked</h6>
            <div class="stat-value" id="total-days">--</div>
        </div>
        <div class="stat-card">
            <h6>Average Completion</h6>
            <div class="stat-value" id="avg-completion">--</div>
        </div>
        <div class="stat-card">
            <h6>Current Streak</h6>
            <div class="stat-value" id="current-streak">--</div>
        </div>
        <div class="stat-card">
            <h6>Best Streak</h6>
            <div class="stat-value" id="best-streak">--</div>
        </div>
    </div>

    <!-- Main Card -->
    <div class="card">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Daily Behavior Records</h5>
                <button class="btn btn-sm btn-outline-primary export-button" onclick="exportToCSV()">
                    <i class="bi bi-download"></i> Export CSV
                </button>
            </div>
        </div>
        <div class="card-body">
            <!-- Date Range Selector -->
            <div class="date-range-selector">
                <div class="form-group">
                    <label for="start-date">Start Date</label>
                    <input type="date" class="form-control" id="start-date">
                </div>
                <div class="form-group">
                    <label for="end-date">End Date</label>
                    <input type="date" class="form-control" id="end-date">
                </div>
                <div class="d-flex gap-2" style="align-self: flex-end;">
                    <button class="btn btn-primary" onclick="loadHistory()">
                        <i class="bi bi-search"></i> Load
                    </button>
                    <button class="btn btn-outline-secondary" onclick="setLast30Days()">
                        Last 30 Days
                    </button>
                    <button class="btn btn-outline-secondary" onclick="setLast7Days()">
                        Last 7 Days
                    </button>
                </div>
            </div>

            <!-- Behavior Legend -->
            <div id="behavior-legend" class="behavior-legend" style="display: none;">
                <!-- Populated by JavaScript -->
            </div>

            <!-- History Table -->
            <div class="behavior-history-table">
                <div id="history-table-container">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/common.js"></script>
<script>
let behaviors = [];
let historyData = [];

document.addEventListener('DOMContentLoaded', async function() {
    // Set default date range (last 30 days)
    setLast30Days();

    // Load behavior definitions
    await loadBehaviors();

    // Load history
    await loadHistory();

    // Load stats
    await loadStats();
});

async function loadBehaviors() {
    try {
        const response = await API.get('/api/behavior/definitions');
        behaviors = response.data;
    } catch (error) {
        console.error('Error loading behaviors:', error);
        showToast('Failed to load behavior definitions', 'error');
    }
}

async function loadHistory() {
    const startDate = document.getElementById('start-date').value;
    const endDate = document.getElementById('end-date').value;

    if (!startDate || !endDate) {
        showToast('Please select both start and end dates', 'warning');
        return;
    }

    try {
        const container = document.getElementById('history-table-container');
        container.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';

        // Fetch logs for date range
        const response = await API.get(`/api/behavior/logs?start_date=${startDate}&end_date=${endDate}&per_page=1000`);
        const logs = response.data.items || response.data;

        // Group logs by date
        const logsByDate = {};
        logs.forEach(log => {
            if (!logsByDate[log.tracked_date]) {
                logsByDate[log.tracked_date] = {};
            }
            logsByDate[log.tracked_date][log.behavior_definition_id] = log;
        });

        // Generate date range
        const dates = generateDateRange(startDate, endDate);

        // Build table
        let html = '<table>';

        // Header row
        html += '<thead><tr>';
        html += '<th class="date-column">Date</th>';
        behaviors.forEach(behavior => {
            // Strip 'bi-' prefix if it exists in icon field
            const iconName = behavior.icon ? behavior.icon.replace(/^bi-/, '') : 'circle';
            html += `<th title="${behavior.name}" style="color: ${behavior.color}; padding: 0.375rem 0.5rem;">
                <i class="bi bi-${iconName}" style="margin: 0 0.125rem;"></i>
            </th>`;
        });
        html += '<th>Total</th>';
        html += '</tr></thead>';

        // Data rows
        html += '<tbody>';
        dates.reverse().forEach(date => {
            const dayLogs = logsByDate[date] || {};
            let completedCount = 0;

            html += '<tr>';
            html += `<td class="date-cell">${DateUtils.formatDateDisplay(date)}</td>`;

            behaviors.forEach(behavior => {
                const log = dayLogs[behavior.id];
                const isCompleted = log && log.completed;
                if (isCompleted) completedCount++;

                html += `<td title="${behavior.name}" style="padding: 0.375rem 0.5rem;">
                    <i class="bi ${isCompleted ? 'bi-check-circle-fill' : 'bi-circle'} behavior-icon ${isCompleted ? 'completed' : ''}"
                       style="color: ${behavior.color}; margin: 0 0.125rem;"></i>
                </td>`;
            });

            html += `<td><strong>${completedCount}/${behaviors.length}</strong></td>`;
            html += '</tr>';
        });
        html += '</tbody>';
        html += '</table>';

        container.innerHTML = html;
        historyData = { dates, logsByDate };

        // Show legend
        renderLegend();

    } catch (error) {
        console.error('Error loading history:', error);
        document.getElementById('history-table-container').innerHTML = `
            <div class="alert alert-danger">Failed to load behavior history</div>
        `;
    }
}

async function loadStats() {
    try {
        const response = await API.get('/api/behavior/stats?days=90');
        const stats = response.data;

        document.getElementById('total-days').textContent = stats.total_days_tracked || 0;
        document.getElementById('avg-completion').textContent = (stats.overall_completion_rate || 0).toFixed(0) + '%';
        document.getElementById('current-streak').textContent = (stats.current_streak || 0) + ' days';
        document.getElementById('best-streak').textContent = (stats.best_streak || 0) + ' days';
    } catch (error) {
        console.error('Error loading stats:', error);
    }
}

function renderLegend() {
    const legendContainer = document.getElementById('behavior-legend');

    if (behaviors.length === 0) {
        legendContainer.style.display = 'none';
        return;
    }

    let html = '';
    behaviors.forEach(behavior => {
        // Strip 'bi-' prefix if it exists in icon field
        const iconName = behavior.icon ? behavior.icon.replace(/^bi-/, '') : 'circle';
        html += `
            <div class="legend-item">
                <i class="bi bi-${iconName}" style="color: ${behavior.color}; font-size: 1.25rem;"></i>
                <span>${behavior.name}</span>
            </div>
        `;
    });

    legendContainer.innerHTML = html;
    legendContainer.style.display = 'flex';
}

function generateDateRange(startDate, endDate) {
    const dates = [];
    const current = new Date(startDate);
    const end = new Date(endDate);

    while (current <= end) {
        dates.push(current.toISOString().split('T')[0]);
        current.setDate(current.getDate() + 1);
    }

    return dates;
}

function setLast30Days() {
    const today = new Date();
    const thirtyDaysAgo = new Date(today);
    thirtyDaysAgo.setDate(today.getDate() - 30);

    document.getElementById('end-date').value = today.toISOString().split('T')[0];
    document.getElementById('start-date').value = thirtyDaysAgo.toISOString().split('T')[0];
}

function setLast7Days() {
    const today = new Date();
    const sevenDaysAgo = new Date(today);
    sevenDaysAgo.setDate(today.getDate() - 7);

    document.getElementById('end-date').value = today.toISOString().split('T')[0];
    document.getElementById('start-date').value = sevenDaysAgo.toISOString().split('T')[0];
}

function exportToCSV() {
    if (!historyData || !historyData.dates) {
        showToast('No data to export', 'warning');
        return;
    }

    // Build CSV
    let csv = 'Date';
    behaviors.forEach(b => csv += ',' + b.name);
    csv += ',Total\n';

    historyData.dates.slice().reverse().forEach(date => {
        csv += DateUtils.formatDateDisplay(date);

        const dayLogs = historyData.logsByDate[date] || {};
        let completedCount = 0;

        behaviors.forEach(behavior => {
            const log = dayLogs[behavior.id];
            const isCompleted = log && log.completed;
            if (isCompleted) completedCount++;
            csv += ',' + (isCompleted ? 'âœ“' : '');
        });

        csv += ',' + completedCount;
        csv += '\n';
    });

    // Download
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `behavior-history-${document.getElementById('start-date').value}-to-${document.getElementById('end-date').value}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);

    showToast('History exported successfully', 'success');
}

function showToast(message, type = 'info') {
    // Simple toast notification (you can enhance this)
    console.log(`[${type.toUpperCase()}] ${message}`);
}
</script>
{% endblock %}
