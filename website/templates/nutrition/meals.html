{% extends "base.html" %}

{% block title %}Meals - Vitruvian Tracker{% endblock %}

{% block content %}
<!-- Dashboard Navbar -->
{% include 'components/navbar_auth.html' %}

<!-- Flash Messages -->
<div class="container mt-3">
    {% include 'components/flash_messages.html' %}
</div>

<!-- Meals Content -->
<div class="page-container">
    <div class="page-header">
        <div class="page-title-section">
            <h1 class="page-title">
                <i class="bi bi-egg-fried"></i> Meal Tracker
            </h1>
            <p class="page-subtitle">Log your daily nutrition and track macros</p>
        </div>
        <div class="page-actions">
            <a href="/nutrition/summary" class="btn btn-outline-primary">
                <i class="bi bi-bar-chart"></i> Summary
            </a>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#mealModal">
                <i class="bi bi-plus-circle"></i> Log Meal
            </button>
        </div>
    </div>

    <!-- Date Navigator -->
    <div class="date-navigator">
        <button class="btn btn-outline-secondary" id="prev-day">
            <i class="bi bi-chevron-left"></i>
        </button>
        <div class="date-display">
            <input type="date" id="current-date" class="form-control">
        </div>
        <button class="btn btn-outline-secondary" id="next-day">
            <i class="bi bi-chevron-right"></i>
        </button>
        <button class="btn btn-outline-primary" id="today-btn">Today</button>
    </div>

    <!-- Daily Summary -->
    <div class="daily-summary">
        <div class="summary-card summary-card-primary">
            <div class="summary-label">Calories</div>
            <div class="summary-value" id="daily-calories">0</div>
            <div class="summary-target">/ <span id="target-calories">2000</span></div>
            <div class="summary-progress">
                <div class="progress">
                    <div class="progress-bar" id="calories-progress" role="progressbar" style="width: 0%"></div>
                </div>
            </div>
        </div>
        <div class="summary-card summary-card-code">
            <div class="summary-label">Protein</div>
            <div class="summary-value" id="daily-protein">0</div>
            <div class="summary-unit">g</div>
            <div class="summary-target">/ <span id="target-protein">150</span> g</div>
            <div class="summary-progress">
                <div class="progress">
                    <div class="progress-bar bg-info" id="protein-progress" role="progressbar" style="width: 0%"></div>
                </div>
            </div>
        </div>
        <div class="summary-card summary-card-fitness">
            <div class="summary-label">Carbs</div>
            <div class="summary-value" id="daily-carbs">0</div>
            <div class="summary-unit">g</div>
            <div class="summary-target">/ <span id="target-carbs">200</span> g</div>
            <div class="summary-progress">
                <div class="progress">
                    <div class="progress-bar bg-warning" id="carbs-progress" role="progressbar" style="width: 0%"></div>
                </div>
            </div>
        </div>
        <div class="summary-card summary-card-ai">
            <div class="summary-label">Fat</div>
            <div class="summary-value" id="daily-fat">0</div>
            <div class="summary-unit">g</div>
            <div class="summary-target">/ <span id="target-fat">65</span> g</div>
            <div class="summary-progress">
                <div class="progress">
                    <div class="progress-bar bg-success" id="fat-progress" role="progressbar" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Macro Distribution Chart -->
    <div class="macro-chart-card">
        <h3 class="chart-title">Macro Distribution</h3>
        <div class="chart-body">
            <canvas id="macroChart"></canvas>
        </div>
    </div>

    <!-- Meals by Type -->
    <div class="meals-container">
        <!-- Breakfast -->
        <div class="meal-section">
            <div class="meal-section-header">
                <h3 class="meal-section-title">
                    <i class="bi bi-sunrise"></i> Breakfast
                </h3>
                <button class="btn btn-sm btn-outline-primary" data-meal-type="breakfast" data-bs-toggle="modal" data-bs-target="#mealModal">
                    <i class="bi bi-plus"></i> Add
                </button>
            </div>
            <div class="meal-entries" id="breakfast-entries">
                <p class="text-muted">No meals logged</p>
            </div>
        </div>

        <!-- Lunch -->
        <div class="meal-section">
            <div class="meal-section-header">
                <h3 class="meal-section-title">
                    <i class="bi bi-sun"></i> Lunch
                </h3>
                <button class="btn btn-sm btn-outline-primary" data-meal-type="lunch" data-bs-toggle="modal" data-bs-target="#mealModal">
                    <i class="bi bi-plus"></i> Add
                </button>
            </div>
            <div class="meal-entries" id="lunch-entries">
                <p class="text-muted">No meals logged</p>
            </div>
        </div>

        <!-- Dinner -->
        <div class="meal-section">
            <div class="meal-section-header">
                <h3 class="meal-section-title">
                    <i class="bi bi-moon-stars"></i> Dinner
                </h3>
                <button class="btn btn-sm btn-outline-primary" data-meal-type="dinner" data-bs-toggle="modal" data-bs-target="#mealModal">
                    <i class="bi bi-plus"></i> Add
                </button>
            </div>
            <div class="meal-entries" id="dinner-entries">
                <p class="text-muted">No meals logged</p>
            </div>
        </div>

        <!-- Snacks -->
        <div class="meal-section">
            <div class="meal-section-header">
                <h3 class="meal-section-title">
                    <i class="bi bi-cup-straw"></i> Snacks
                </h3>
                <button class="btn btn-sm btn-outline-primary" data-meal-type="snack" data-bs-toggle="modal" data-bs-target="#mealModal">
                    <i class="bi bi-plus"></i> Add
                </button>
            </div>
            <div class="meal-entries" id="snack-entries">
                <p class="text-muted">No snacks logged</p>
            </div>
        </div>
    </div>
</div>

<!-- Meal Modal (Add/Edit) -->
<div class="modal fade" id="mealModal" tabindex="-1" aria-labelledby="mealModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="mealModalLabel">Log Meal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="meal-form">
                <div class="modal-body">
                    <input type="hidden" id="meal-id" name="meal_id">
                    <input type="hidden" id="meal-date" name="date">

                    <div class="mb-3">
                        <label for="meal-type" class="form-label">Meal Type <span class="text-danger">*</span></label>
                        <select class="form-select" id="meal-type" name="meal_type" required>
                            <option value="breakfast">Breakfast</option>
                            <option value="lunch">Lunch</option>
                            <option value="dinner">Dinner</option>
                            <option value="snack">Snack</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="meal-time" class="form-label">Time</label>
                        <input type="time" class="form-control" id="meal-time" name="time">
                    </div>

                    <div class="mb-3">
                        <label for="meal-description" class="form-label">Description <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="meal-description" name="description" rows="3"
                                  placeholder="What did you eat?" required></textarea>
                        <div class="invalid-feedback">Please enter a meal description.</div>
                    </div>

                    <div class="macros-section">
                        <h6 class="mb-3">Macronutrients</h6>
                        <div class="row">
                            <div class="col-6 mb-3">
                                <label for="meal-calories" class="form-label">Calories <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="meal-calories" name="calories"
                                       placeholder="500" min="0" required>
                            </div>
                            <div class="col-6 mb-3">
                                <label for="meal-protein" class="form-label">Protein (g)</label>
                                <input type="number" step="0.1" class="form-control" id="meal-protein" name="protein"
                                       placeholder="30">
                            </div>
                            <div class="col-6 mb-3">
                                <label for="meal-carbs" class="form-label">Carbs (g)</label>
                                <input type="number" step="0.1" class="form-control" id="meal-carbs" name="carbs"
                                       placeholder="50">
                            </div>
                            <div class="col-6 mb-3">
                                <label for="meal-fat" class="form-label">Fat (g)</label>
                                <input type="number" step="0.1" class="form-control" id="meal-fat" name="fat"
                                       placeholder="15">
                            </div>
                        </div>

                        <div class="macro-percentages" id="macro-percentages">
                            <!-- Calculated percentages will appear here -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle"></i> Save Meal
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
{% from 'components/modal.html' import delete_modal %}
{{ delete_modal('deleteMealModal') }}

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="/static/js/common.js"></script>
<script src="/static/js/nutrition.js"></script>
{% endblock %}
