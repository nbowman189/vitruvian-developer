{% extends "base.html" %}

{% block title %}Coaching Sessions - Vitruvian Tracker{% endblock %}

{% block extra_css %}
<style>
.coaching-session-card {
    border: 1px solid #dee2e6;
    transition: box-shadow 0.2s ease;
}

.coaching-session-card:hover {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.coaching-session-header {
    background-color: #f8f9fa;
    transition: background-color 0.2s ease;
}

.coaching-session-header:hover {
    background-color: #e9ecef;
}

.session-chevron {
    transition: transform 0.2s ease;
    font-size: 1rem;
    color: var(--primary-color, #2563eb);
}

.expand-text {
    transition: opacity 0.2s ease;
}

.coaching-session-header:hover .expand-text {
    opacity: 0.7;
}

.session-notes-full {
    padding: 2rem !important;
}

.coaching-notes {
    line-height: 1.8;
    color: #2c3e50;
    font-size: 1rem;
    max-width: 100%;
}

/* Headings */
.coaching-notes h1,
.coaching-notes h2,
.coaching-notes h3,
.coaching-notes h4,
.coaching-notes h5,
.coaching-notes h6 {
    margin-top: 2rem;
    margin-bottom: 1rem;
    font-weight: 600;
    line-height: 1.3;
    color: #1a202c;
}

.coaching-notes h1:first-child,
.coaching-notes h2:first-child,
.coaching-notes h3:first-child {
    margin-top: 0;
}

.coaching-notes h1 {
    font-size: 2rem;
    border-bottom: 3px solid #e2e8f0;
    padding-bottom: 0.5rem;
    margin-bottom: 1.5rem;
}

.coaching-notes h2 {
    font-size: 1.75rem;
    border-bottom: 2px solid #e2e8f0;
    padding-bottom: 0.4rem;
}

.coaching-notes h3 {
    font-size: 1.5rem;
    color: var(--primary-color, #2563eb);
}

.coaching-notes h4 {
    font-size: 1.25rem;
}

/* Paragraphs and text */
.coaching-notes p {
    margin-bottom: 1.25rem;
    line-height: 1.8;
}

/* Lists */
.coaching-notes ul,
.coaching-notes ol {
    margin-bottom: 1.5rem;
    padding-left: 2rem;
}

.coaching-notes li {
    margin-bottom: 0.75rem;
    line-height: 1.7;
}

.coaching-notes ul ul,
.coaching-notes ol ol,
.coaching-notes ul ol,
.coaching-notes ol ul {
    margin-top: 0.5rem;
    margin-bottom: 0.5rem;
}

/* Code */
.coaching-notes code {
    background-color: #f7fafc;
    color: #e53e3e;
    padding: 0.2em 0.4em;
    border-radius: 0.25rem;
    font-size: 0.9em;
    font-family: 'Courier New', Courier, monospace;
    border: 1px solid #e2e8f0;
}

.coaching-notes pre {
    background-color: #2d3748;
    color: #e2e8f0;
    padding: 1.5rem;
    border-radius: 0.5rem;
    overflow-x: auto;
    margin-bottom: 1.5rem;
    line-height: 1.5;
}

.coaching-notes pre code {
    background-color: transparent;
    color: inherit;
    padding: 0;
    border: none;
    font-size: 0.95em;
}

/* Blockquotes */
.coaching-notes blockquote {
    border-left: 4px solid var(--primary-color, #2563eb);
    padding: 1rem 1.5rem;
    margin: 1.5rem 0;
    background-color: #f7fafc;
    border-radius: 0 0.25rem 0.25rem 0;
    color: #4a5568;
}

.coaching-notes blockquote p {
    margin-bottom: 0.5rem;
}

.coaching-notes blockquote p:last-child {
    margin-bottom: 0;
}

/* Strong and emphasis */
.coaching-notes strong {
    font-weight: 700;
    color: #1a202c;
}

.coaching-notes em {
    font-style: italic;
    color: #4a5568;
}

/* Horizontal rules */
.coaching-notes hr {
    margin: 2.5rem 0;
    border: 0;
    border-top: 2px solid #e2e8f0;
}

/* Tables */
.coaching-notes table {
    border-collapse: collapse;
    width: 100%;
    margin-bottom: 1.5rem;
    overflow-x: auto;
    display: block;
}

.coaching-notes th,
.coaching-notes td {
    border: 1px solid #e2e8f0;
    padding: 0.75rem 1rem;
    text-align: left;
}

.coaching-notes th {
    background-color: #f7fafc;
    font-weight: 600;
    color: #1a202c;
}

.coaching-notes tr:nth-child(even) {
    background-color: #f7fafc;
}

/* Links */
.coaching-notes a {
    color: var(--primary-color, #2563eb);
    text-decoration: none;
    border-bottom: 1px solid transparent;
    transition: border-bottom-color 0.2s;
}

.coaching-notes a:hover {
    border-bottom-color: var(--primary-color, #2563eb);
}

/* Images */
.coaching-notes img {
    max-width: 100%;
    height: auto;
    border-radius: 0.5rem;
    margin: 1.5rem 0;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}
</style>
{% endblock %}

{% block content %}
<!-- Dashboard Navbar -->
{% include 'components/navbar_auth.html' %}

<!-- Flash Messages -->
<div class="container mt-3">
    {% include 'components/flash_messages.html' %}
</div>

<!-- Coaching Sessions Content -->
<div class="dashboard-container">
    <section class="page-header">
        <h1><i class="bi bi-clipboard-data"></i> Coaching Log</h1>
        <p class="text-muted">Historical coaching sessions and feedback</p>
        <div class="mt-3">
            <a href="/ai-coach" class="btn btn-primary">
                <i class="bi bi-robot"></i> Go to AI Coach
            </a>
        </div>
    </section>

    <!-- Coaching Sessions List -->
    <div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0">Coaching Sessions</h5>
        </div>
        <div class="card-body">
            <div id="sessions-list-container">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Active Goals -->
    <div class="card mt-4">
        <div class="card-header">
            <h5 class="card-title mb-0">Active Goals</h5>
        </div>
        <div class="card-body">
            <div id="goals-list-container">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/common.js"></script>
<script>
document.addEventListener('DOMContentLoaded', async function() {
    await loadSessions();
    await loadGoals();
});

async function loadSessions() {
    try {
        const response = await API.get('/api/coaching/sessions?per_page=20&sort=desc');
        const sessions = response.data;

        const container = document.getElementById('sessions-list-container');

        if (!sessions || sessions.length === 0) {
            container.innerHTML = '<p class="text-muted text-center">No coaching sessions found</p>';
            return;
        }

        let html = '';
        sessions.forEach((session, index) => {
            const title = session.coach_feedback || 'Coaching Session';
            const hasContent = session.discussion_notes && session.discussion_notes.length > 0;

            html += `
                <div class="card mb-3 coaching-session-card">
                    <div class="card-header coaching-session-header" style="cursor: pointer;" onclick="toggleSessionNotes(${session.id})">
                        <div class="d-flex w-100 justify-content-between align-items-center">
                            <div class="d-flex align-items-center gap-2">
                                <div>
                                    <h6 class="mb-0">${title}</h6>
                                    <small class="text-muted">
                                        <i class="bi bi-calendar3"></i> ${DateUtils.formatDateDisplay(session.session_date)}
                                        ${session.duration_minutes ? `<span class="ms-2"><i class="bi bi-clock"></i> ${session.duration_minutes} mins</span>` : ''}
                                    </small>
                                </div>
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                <span class="expand-text" id="expand-text-${session.id}">
                                    <small class="text-muted">Click to expand</small>
                                </span>
                                <i class="bi bi-chevron-right session-chevron" id="chevron-${session.id}"></i>
                            </div>
                        </div>
                    </div>
                    <div class="card-body session-notes-full" id="session-full-${session.id}" style="display: none;">
                        ${hasContent ?
                            '<div class="markdown-content coaching-notes"></div>' :
                            '<p class="text-muted">No session content</p>'}
                    </div>
                </div>
            `;
        });

        container.innerHTML = html;

        // Render markdown content for each session
        sessions.forEach(session => {
            const markdownDiv = document.querySelector(`#session-full-${session.id} .markdown-content`);
            if (markdownDiv && session.discussion_notes) {
                markdownDiv.innerHTML = marked.parse(session.discussion_notes);
            }
        });
    } catch (error) {
        console.error('Error loading sessions:', error);
        document.getElementById('sessions-list-container').innerHTML = `
            <div class="alert alert-danger">Failed to load sessions</div>
        `;
    }
}

async function loadGoals() {
    try {
        const response = await API.get('/api/coaching/goals');
        const goals = response.data;

        const container = document.getElementById('goals-list-container');

        if (!goals || goals.length === 0) {
            container.innerHTML = '<p class="text-muted text-center">No active goals</p>';
            return;
        }

        let html = '<div class="list-group">';
        goals.forEach(goal => {
            const isCompleted = goal.is_completed;
            const badge = isCompleted ?
                '<span class="badge bg-success">Completed</span>' :
                '<span class="badge bg-primary">Active</span>';

            html += `
                <div class="list-group-item">
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">${goal.goal_text}</h6>
                        ${badge}
                    </div>
                    ${goal.target_date ? `<small>Target: ${DateUtils.formatDateDisplay(goal.target_date)}</small>` : ''}
                </div>
            `;
        });
        html += '</div>';

        container.innerHTML = html;
    } catch (error) {
        console.error('Error loading goals:', error);
        document.getElementById('goals-list-container').innerHTML = `
            <div class="alert alert-danger">Failed to load goals</div>
        `;
    }
}

// Toggle session notes visibility
function toggleSessionNotes(sessionId) {
    const full = document.getElementById(`session-full-${sessionId}`);
    const chevron = document.getElementById(`chevron-${sessionId}`);
    const expandText = document.getElementById(`expand-text-${sessionId}`);

    // Check current state - if visible (expanded), we'll collapse it
    const isExpanded = full.style.display !== 'none';

    if (isExpanded) {
        // Collapse: hide content
        full.style.display = 'none';
        chevron.classList.remove('bi-chevron-down');
        chevron.classList.add('bi-chevron-right');
        if (expandText) {
            expandText.innerHTML = '<small class="text-muted">Click to expand</small>';
        }
    } else {
        // Expand: show content
        full.style.display = 'block';
        chevron.classList.remove('bi-chevron-right');
        chevron.classList.add('bi-chevron-down');
        if (expandText) {
            expandText.innerHTML = '<small class="text-muted">Click to collapse</small>';
        }
    }
}
</script>
{% endblock %}
