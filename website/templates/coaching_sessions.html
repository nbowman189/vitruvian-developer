{% extends "base.html" %}

{% block title %}Coaching Sessions - Vitruvian Tracker{% endblock %}

{% block content %}
<!-- Dashboard Navbar -->
{% include 'components/navbar_auth.html' %}

<!-- Flash Messages -->
<div class="container mt-3">
    {% include 'components/flash_messages.html' %}
</div>

<!-- Coaching Sessions Content -->
<div class="dashboard-container">
    <section class="page-header">
        <h1><i class="bi bi-clipboard-data"></i> Coaching Log</h1>
        <p class="text-muted">Historical coaching sessions and feedback</p>
        <div class="mt-3">
            <a href="/ai-coach" class="btn btn-primary">
                <i class="bi bi-robot"></i> Go to AI Coach
            </a>
        </div>
    </section>

    <!-- Coaching Sessions List -->
    <div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0">Coaching Sessions</h5>
        </div>
        <div class="card-body">
            <div id="sessions-list-container">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Active Goals -->
    <div class="card mt-4">
        <div class="card-header">
            <h5 class="card-title mb-0">Active Goals</h5>
        </div>
        <div class="card-body">
            <div id="goals-list-container">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/common.js"></script>
<script>
document.addEventListener('DOMContentLoaded', async function() {
    await loadSessions();
    await loadGoals();
});

async function loadSessions() {
    try {
        const response = await API.get('/api/coaching/sessions?per_page=20&sort=desc');
        const sessions = response.data;

        const container = document.getElementById('sessions-list-container');

        if (!sessions || sessions.length === 0) {
            container.innerHTML = '<p class="text-muted text-center">No coaching sessions found</p>';
            return;
        }

        let html = '';
        sessions.forEach((session, index) => {
            const discussionPreview = session.discussion_notes ?
                session.discussion_notes.substring(0, 200) + '...' :
                'No discussion notes';

            html += `
                <div class="card mb-3">
                    <div class="card-header">
                        <div class="d-flex w-100 justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <i class="bi bi-calendar3"></i> ${DateUtils.formatDateDisplay(session.session_date)}
                                ${session.coach_feedback ? ' - ' + session.coach_feedback : ''}
                            </h6>
                            ${session.duration_minutes ? `<span class="badge bg-primary">${session.duration_minutes} mins</span>` : ''}
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="session-notes-preview" id="session-preview-${session.id}">
                            <p class="text-muted">${discussionPreview}</p>
                            ${session.discussion_notes && session.discussion_notes.length > 200 ?
                                `<button class="btn btn-sm btn-outline-primary" onclick="toggleSessionNotes(${session.id})">
                                    <i class="bi bi-chevron-down"></i> Show Full Notes
                                </button>` : ''}
                        </div>
                        <div class="session-notes-full" id="session-full-${session.id}" style="display: none;">
                            <div class="markdown-content"></div>
                            <button class="btn btn-sm btn-outline-secondary mt-2" onclick="toggleSessionNotes(${session.id})">
                                <i class="bi bi-chevron-up"></i> Show Less
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });

        container.innerHTML = html;

        // Render markdown content for each session
        sessions.forEach(session => {
            const markdownDiv = document.querySelector(`#session-full-${session.id} .markdown-content`);
            if (markdownDiv && session.discussion_notes) {
                markdownDiv.innerHTML = marked.parse(session.discussion_notes);
            }
        });
    } catch (error) {
        console.error('Error loading sessions:', error);
        document.getElementById('sessions-list-container').innerHTML = `
            <div class="alert alert-danger">Failed to load sessions</div>
        `;
    }
}

async function loadGoals() {
    try {
        const response = await API.get('/api/coaching/goals');
        const goals = response.data;

        const container = document.getElementById('goals-list-container');

        if (!goals || goals.length === 0) {
            container.innerHTML = '<p class="text-muted text-center">No active goals</p>';
            return;
        }

        let html = '<div class="list-group">';
        goals.forEach(goal => {
            const isCompleted = goal.is_completed;
            const badge = isCompleted ?
                '<span class="badge bg-success">Completed</span>' :
                '<span class="badge bg-primary">Active</span>';

            html += `
                <div class="list-group-item">
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">${goal.goal_text}</h6>
                        ${badge}
                    </div>
                    ${goal.target_date ? `<small>Target: ${DateUtils.formatDateDisplay(goal.target_date)}</small>` : ''}
                </div>
            `;
        });
        html += '</div>';

        container.innerHTML = html;
    } catch (error) {
        console.error('Error loading goals:', error);
        document.getElementById('goals-list-container').innerHTML = `
            <div class="alert alert-danger">Failed to load goals</div>
        `;
    }
}

// Toggle session notes visibility
function toggleSessionNotes(sessionId) {
    const preview = document.getElementById(`session-preview-${sessionId}`);
    const full = document.getElementById(`session-full-${sessionId}`);

    if (preview.style.display === 'none') {
        preview.style.display = 'block';
        full.style.display = 'none';
    } else {
        preview.style.display = 'none';
        full.style.display = 'block';
    }
}
</script>
{% endblock %}
